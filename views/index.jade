doctype html
html
    head
        title Device Management
        link(href='//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css', rel='stylesheet')
        script(type='text/javascript', src="https://code.jquery.com/jquery-2.1.3.js")
        
    body
        div.container
            div.jumbotron
                h1 Devices
                p View, manage and control the devices in your network from here.
        
        div(class="panel panel-default"  style="float: none; width: 960px; margin-left:auto; margin-right:auto;")  
            div(class="panel-heading") Available Devices     
            div(class="panel-body")
                ul(id="devices")


        script(type='text/javascript').
            $(function() {
                loadDevices();
            })

            function loadDevices() {
                var deviceArray = !{devices};
                var devicesElement = document.getElementById("devices");
                // iterate through the devices and create & populate the relavent DOM elements
                for(var i = 0; i < deviceArray.length; i++) {
                    var eventSource = null;
                    // create base list element
                    var uuid = deviceArray[i].sessionId;
                    var element = "listElement" + uuid;
                    var device_div_li = document.createElement("li");
                    device_div_li.id = element;
                    // device icon
                    var device_icon = document.createElement("img");
                    device_icon.src = "images/device_icon.png";
                    device_icon.style.width = "120px";
                    device_icon.style.margin = "15px";
                    device_icon.onclick = function() {
                        console.log("toggling " + "#" + element + " .device");
                        $("#" + element + " .device").toggle();
                    };
                    // add icon to list element
                    device_div_li.appendChild(device_icon);
                    device_div_li.setAttribute("style", "list-style:none;"); 

                    // Device Properties
                    //=================================================
                    var device_div = document.createElement("div");
                    device_div.className = "device";
                    device_div.innerHTML = "<b><u>DEVICE:</u></b>";
                    device_div.setAttribute("style", "display: none;");
                    // device id
                    var device_id = document.createElement("div");
                    device_id.className = "device_id";
                    var deviceId = deviceArray[i].sessionId   // Device ID
                    device_id.innerHTML =  "<strong>ID:</strong> " + deviceId;
                    // device manufacturer
                    var device_man = document.createElement("div");
                    device_man.className = "manufacturer";
                    device_man.innerHTML = "<strong>Manufacturer:</strong> " + deviceArray[i].manufacturer;
                    // device model
                    var device_mod = document.createElement("div");
                    device_mod.className = "model"
                    device_mod.innerHTML = "<strong>Model:</strong> " + deviceArray[i].model;
                    // geo location
                    var device_geo = document.createElement("div");
                    device_geo.className = "geo-location";
                    var device_geo_lon = document.createElement("div");
                    device_geo_lon.className = "longitude";
                    device_geo_lon.innerHTML = "<strong>Longitude:</strong> " + deviceArray[i].geo.longitude;
                    var device_geo_lat = document.createElement("div");
                    device_geo_lat.className = "latitude";
                    device_geo_lat.innerHTML = "<strong>Latitude:</strong> " + deviceArray[i].geo.latitude;
                    device_geo.appendChild(device_geo_lon);
                    device_geo.appendChild(device_geo_lat);
                    // add sub divs to device div
                    device_div.appendChild(device_id);
                    device_div.appendChild(device_man);
                    device_div.appendChild(device_mod);
                    device_div.appendChild(device_geo);
                    // iterate through sensors
                    var sensorArray = deviceArray[i].sensors;
                    var sensors_div = document.createElement("div");
                    sensors_div.innerHTML = "<b><u>SENSORS:</u></b>";
                    sensors_div.id = "sensors_div";
                    for(var j = 0; j < sensorArray.length; j++) {
                        // create base div for each sensor
                        var sensor_div =  document.createElement("div");
                        // sensor id
                        sensor_div.id = "sensor_div";
                        var sensor_id = document.createElement("div");
                        var sensorId = sensorArray[j].id; // Sensor ID
                        sensor_id.className = "sensor_id";
                        sensor_id.innerHTML = "<strong>ID:</strong> " + sensorId;
                        // sensor name
                        var sensor_name = document.createElement("div");
                        sensor_name.innerHTML = "<strong>Name:</strong> " + sensorArray[j].name;
                        sensor_name.className = "name";
                        // sensor sense
                        var sensor_sense = document.createElement("div");
                        sensor_sense.className = "sense";
                        sensor_sense.innerHTML = "<strong>Sense:</strong> " + sensorArray[j].sense;
                        // sensor unit
                        var sensor_unit = document.createElement("div");
                        sensor_unit.className = "unit";
                        sensor_unit.innerHTML = "<strong>Unit:</strong> " + sensorArray[j].unit;
                        // sensor type
                        var sensor_type = document.createElement("div");
                        sensor_type.className = "type";
                        sensor_type.innerHTML = "<strong>Type:</strong> " + sensorArray[j].type;
                        // add sub divs to sensor base div
                        sensor_div.appendChild(sensor_id);
                        sensor_div.appendChild(sensor_name);
                        sensor_div.appendChild(sensor_sense);
                        sensor_div.appendChild(sensor_unit);
                        sensor_div.appendChild(sensor_type);
                        sensors_div.appendChild(sensor_div);
                         // Streaming button to load graph
                        var startStreamBtn = document.createElement("button");
                        startStreamBtn.className = "btn";
                        startStreamBtn.innerHTML = "Start streaming data";
                        startStreamBtn.style.margin = "5px";
                        startStreamBtn.addEventListener('click', function() {

                            console.log("Starting stream on sensor " + sensorId);
                            eventSource = new EventSource("http://192.168.174.150:8080/thing-web/devices/" + deviceId + "/sensors/" + sensorId+ "/stream");
                            eventSource.onopen = function() {
                                $("#liveStream").text("Connecting...");
                            };
                            eventSource.onmessage = function(message) {
                                $("#liveStream").text(message.data);
                            };
                            eventSource.onerror = function() {
                                $("#liveStream").text("Error!");
                            };
                        });
                        sensors_div.appendChild(startStreamBtn);

                        var stopStreamBtn = document.createElement("button");
                        stopStreamBtn.className = "btn";
                        stopStreamBtn.innerHTML = "Stop streaming data";
                        stopStreamBtn.style.margin = "5px";
                        stopStreamBtn.addEventListener('click', function() {

                            var http = new XMLHttpRequest();
                            var url = "http://192.168.174.150:8080/thing-web/devices/" + deviceId + "/sensors/" + sensorId+ "/stream";
                            var params = "";
                            http.open("POST", url, true);

                            //Send the proper header information along with the request
                            http.setRequestHeader("Content-type", "application/json");
                            http.setRequestHeader("Content-length", params.length);
                            http.setRequestHeader("Connection", "close");

                            http.onreadystatechange = function() {//Call a function when the state changes.
                                if(http.readyState == 4 && http.status == 200) {
                                    alert(http.responseText);
                                }
                            }
                            http.send(params);
                            console.log("Stopping stream on sensor");
                            eventSource.close();
                        })
                        sensors_div.appendChild(stopStreamBtn);
                        var liveStream = document.createElement("div");
                        liveStream.id = "liveStream";
                        sensors_div.appendChild(liveStream);
                    }// end sensor loop
                    // add sensors div to device div
                    device_div.appendChild(sensors_div);
                    // iterate through the actuators
                    var actuatorArray = deviceArray[i].actuators;
                    var actuators_div = document.createElement("div");
                    actuators_div.innerHTML = "<b><u>ACTUATORS:</u></b>";
                    actuators_div.id = "actuators_div";
                    for(var k = 0; k < actuatorArray.length; k++) {
                        // create a base div for each actuator
                        var actuator_div =  document.createElement("div");
                        // actuator id
                        actuator_div.id = "actuator_div";
                        var actuator_id = document.createElement("div");
                        actuator_id.className = "actuator_id";
                        var actuatorId = actuatorArray[k].id;
                        actuator_id.innerHTML = "<strong>ID:</strong> " + actuatorId;
                        // actuator name
                        var actuator_name = document.createElement("div");
                        actuator_name.className = "name";
                        actuator_name.innerHTML = "<strong>Name:</strong> " + actuatorArray[k].name;
                        // actuator options
                        var actuatorOptions = actuatorArray[k].options;
                        var actuator_options = document.createElement("div");
                        actuator_options.innerHTML = "<b><u>OPTIONS:</u></b><br />";
                        actuator_options.className = "options";
                        for(var _w = 0; _w < actuatorOptions.length; _w++) {
                            // Use a closure to keep scope correct
                            (function(w) {
                                // create a button for each option
                                var optionBtn = document.createElement("button");
                                optionBtn.className = "option";
                                var optionText = actuatorOptions[w];
                                optionBtn.innerHTML = optionText;
                                optionBtn.className = "btn btn-primary";
                                optionBtn.setAttribute("style", "margin: 5px");
                                optionBtn.addEventListener('click', function(event) {
                                        console.log("Invoking option " + optionText);
                                        var url = "http://192.168.174.150:8080/thing-web/devices/" + deviceId + "/actuators/" + actuatorId;
                                        var http = new XMLHttpRequest();
                                        http.open("POST", url, false);

                                        //Send the proper header information along with the request
                                        http.setRequestHeader("Content-type", "application/json");
                                        http.send(JSON.stringify({data: optionText}));
                                })
                                actuator_options.appendChild(optionBtn);
                            })(_w);
                            
                        }// end actuator options loop
                        // add each actuator property to the actuator div
                        actuator_div.appendChild(actuator_id);
                        actuator_div.appendChild(actuator_name);
                        actuator_div.appendChild(actuator_options);
                        actuators_div.appendChild(actuator_div);
                    }// end actuator loop
                    // add the actuators div to the device
                    device_div.appendChild(actuators_div);
                    // add device to device list div
                    device_div_li.appendChild(device_div);
                    // add the device into the devices div
                    devicesElement.appendChild(device_div_li);
                }// end device
            }// end devices
